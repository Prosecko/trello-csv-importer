<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>CSV Trello Importer</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://trello.github.io/power-up-client/TrelloPowerUp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
      body {
        background-color: #0a192f;
        color: #ccd6f6;
        font-family: Arial, sans-serif;
        text-align: center;
      }
      h1 {
        color: #89cff0;
      }
      .top-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
      }
      input, button {
        background-color: #112240;
        color: #ccd6f6;
        border: 1px solid #89cff0;
        padding: 10px;
        cursor: pointer;
      }
      button:hover {
        background-color: #89cff0;
        color: #0a192f;
      }
      #preview {
        background-color: #112240;
        padding: 15px;
        border-radius: 8px;
        max-width: 600px;
        margin: 20px auto;
        text-align: left;
      }
      ul {
        list-style-type: none;
        padding: 0;
      }
      li {
        background-color: #233554;
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
      }
      strong {
        color: #89cff0;
      }
    </style>
  </head>
  <body>
    <h1>CSV Importer</h1>
    <div class="top-container">
      <input type="file" id="csvInput" accept=".csv">
      <button id="importBtn">Importiere CSV</button>
    </div>
    <div id="preview"></div>
    
    <script>
      function waitForTrelloAPI() {
        return new Promise((resolve, reject) => {
          let attempts = 0;
          const interval = setInterval(() => {
            if (window.TrelloPowerUp) {
              clearInterval(interval);
              resolve(window.TrelloPowerUp.iframe());
            }
            if (attempts > 20) {
              clearInterval(interval);
              reject("Trello API Timeout");
            }
            attempts++;
          }, 500);
        });
      }
      
      waitForTrelloAPI().then(t => {
        console.log("Trello API detected, initializing Power-Up");
        t.initialize({
          "board-buttons": function (t, opts) {
            return [
              {
                icon: "https://cdn-icons-png.flaticon.com/512/2919/2919592.png",
                text: "CSV Import",
                callback: function (t) {
                  document.getElementById('csvInput').click();
                }
              }
            ];
          },
          "card-buttons": function (t, opts) {
            return [
              {
                icon: "https://cdn-icons-png.flaticon.com/512/2919/2919592.png",
                text: "CSV Import",
                callback: function (t) {
                  document.getElementById('csvInput').click();
                }
              }
            ];
          }
        });
      }).catch(error => {
        console.error("Error initializing Trello Power-Up:", error);
      });

      document.getElementById('csvInput').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) {
          document.getElementById('preview').innerHTML = '';
          return;
        }

        Papa.parse(file, {
          header: true,
          complete: function(results) {
            if (results.data.length === 0) {
              document.getElementById('preview').innerHTML = '<p>Die CSV-Datei ist leer oder fehlerhaft.</p>';
              return;
            }
            displayPreview(results.data);
          },
          error: function(err) {
            console.error('CSV Parsing Error:', err);
            document.getElementById('preview').innerHTML = '<p>Fehler beim Parsen der CSV-Datei.</p>';
          }
        });
      });
      
      function displayPreview(dataArray) {
        let previewDiv = document.getElementById('preview');
        previewDiv.innerHTML = '<h3>Vorschau der zu erstellenden Karten:</h3>';
        let previewList = '<ul>';
        
        let currentCard = null;
        let cardChecklists = {};

        dataArray.forEach(item => {
          if (item['Card Name']) {
            currentCard = item['Card Name'];
            cardChecklists[currentCard] = {
              description: item['Card Description'] || 'Keine Beschreibung',
              members: item['Members'] || 'Keine Mitglieder',
              labels: item['Labels'] || 'Keine Labels',
              checklist: item['Checklist'] || 'Keine Checkliste',
              checklistItems: []
            };
          } else if (currentCard && item['Checklist item']) {
            cardChecklists[currentCard].checklistItems.push({
              name: item['Checklist item'],
              due: item['Checklist item due'] || 'Kein Fälligkeitsdatum',
              member: item['Checklist item member'] || 'Kein Mitglied'
            });
          }
        });
        
        for (const [cardName, cardData] of Object.entries(cardChecklists)) {
          previewList += `<li>
            <strong>${cardName}</strong> - ${cardData.description}
            <br><strong>Mitglieder:</strong> ${cardData.members}
            <br><strong>Labels:</strong> ${cardData.labels}
            <br><strong>Checkliste:</strong> ${cardData.checklist || 'Keine Checkliste'}
            <br><strong>Checklisten-Einträge:</strong>
            <ul>`;
          
          cardData.checklistItems.forEach(item => {
            previewList += `<li>${item.name} (Fällig: ${item.due}, Mitglied: ${item.member})</li>`;
          });
          
          previewList += `</ul></li><br>`;
        }
        
        previewList += '</ul>';
        previewDiv.innerHTML += previewList;
      }
    </script>
  </body>
</html>
